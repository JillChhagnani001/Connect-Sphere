# Connect Sphere Database Schema

This document outlines the schema for the Connect Sphere database, including tables, enums, functions, triggers, and Row Level Security (RLS) policies.

---

## Enums (Custom Types)

### `public.privacy_level`

```sql
CREATE TYPE public.privacy_level AS ENUM (
  'public',
  'followers',
  'private'
);
```

### `public.reaction_type`

```sql
CREATE TYPE public.reaction_type AS ENUM (
  'like',
  'love',
  'laugh',
  'wow',
  'sad',
  'angry'
);
```

---

## Tables

### `public.profiles`

Stores user profile data. `follower_count` and `following_count` are maintained by triggers.

```sql
CREATE TABLE public.profiles (
  id uuid NOT NULL PRIMARY KEY,
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NULL,
  display_name text NULL,
  username text UNIQUE NULL,
  bio text NULL,
  avatar_url text NULL,
  website text NULL,
  location text NULL,
  follower_count integer DEFAULT 0,
  following_count integer DEFAULT 0,
  CONSTRAINT profiles_id_fkey FOREIGN KEY (id) REFERENCES auth.users (id) ON DELETE CASCADE
);
```

---

### `public.privacy_settings`

Stores privacy preferences for users.

```sql
CREATE TABLE public.privacy_settings (
  user_id uuid NOT NULL PRIMARY KEY,
  profile_visibility public.privacy_level NOT NULL DEFAULT 'public'::privacy_level,
  post_visibility public.privacy_level NOT NULL DEFAULT 'public'::privacy_level,
  show_online_status boolean NOT NULL DEFAULT true,
  allow_follow_requests boolean NOT NULL DEFAULT true,
  allow_direct_messages public.privacy_level NOT NULL DEFAULT 'public'::privacy_level,
  show_followers boolean NOT NULL DEFAULT true,
  show_following boolean NOT NULL DEFAULT true,
  allow_tagging boolean NOT NULL DEFAULT true,
  allow_mentions public.privacy_level NOT NULL DEFAULT 'public'::privacy_level,
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NULL,
  CONSTRAINT privacy_settings_user_id_fkey FOREIGN KEY (user_id) REFERENCES profiles (id) ON DELETE CASCADE
);
```

---

### `public.followers`

Stores accepted follow relationships.

```sql
CREATE TABLE public.followers (
  follower_id uuid NOT NULL,
  following_id uuid NOT NULL,
  created_at timestamptz NOT NULL DEFAULT now(),
  PRIMARY KEY (follower_id, following_id),
  CONSTRAINT followers_follower_id_fkey FOREIGN KEY (follower_id) REFERENCES profiles (id) ON DELETE CASCADE,
  CONSTRAINT followers_following_id_fkey FOREIGN KEY (following_id) REFERENCES profiles (id) ON DELETE CASCADE
);

-- Triggers
CREATE TRIGGER on_new_follow
AFTER INSERT ON public.followers
FOR EACH ROW
EXECUTE FUNCTION handle_new_follower();

CREATE TRIGGER on_unfollow
AFTER DELETE ON public.followers
FOR EACH ROW
EXECUTE FUNCTION handle_lost_follower();
```

---

### `public.follow_requests`

Stores pending follow requests.

```sql
CREATE TABLE public.follow_requests (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  follower_id uuid NOT NULL,
  following_id uuid NOT NULL,
  created_at timestamptz NOT NULL DEFAULT now(),
  CONSTRAINT follow_requests_follower_id_fkey FOREIGN KEY (follower_id) REFERENCES profiles (id) ON DELETE CASCADE,
  CONSTRAINT follow_requests_following_id_fkey FOREIGN KEY (following_id) REFERENCES profiles (id) ON DELETE CASCADE,
  CONSTRAINT follow_requests_unique UNIQUE (follower_id, following_id)
);
```

---

### `public.posts`

```sql
CREATE TABLE public.posts (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id uuid NOT NULL,
  text text NULL,
  media jsonb[] NULL,
  hashtags text[] NULL,
  location text NULL,
  visibility public.privacy_level NOT NULL DEFAULT 'public'::privacy_level,
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NULL,
  like_count integer DEFAULT 0,
  share_count integer DEFAULT 0,
  save_count integer DEFAULT 0,
  comment_count integer DEFAULT 0,
  CONSTRAINT posts_user_id_fkey FOREIGN KEY (user_id) REFERENCES profiles (id) ON DELETE CASCADE
);
```

---

### `public.comments`

```sql
CREATE TABLE public.comments (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  post_id BIGINT NOT NULL,
  user_id uuid NOT NULL,
  text text NOT NULL,
  parent_id BIGINT NULL,
  created_at timestamptz NOT NULL DEFAULT now(),
  CONSTRAINT comments_post_id_fkey FOREIGN KEY (post_id) REFERENCES posts (id) ON DELETE CASCADE,
  CONSTRAINT comments_user_id_fkey FOREIGN KEY (user_id) REFERENCES profiles (id) ON DELETE CASCADE,
  CONSTRAINT comments_parent_id_fkey FOREIGN KEY (parent_id) REFERENCES comments (id) ON DELETE CASCADE
);

CREATE TRIGGER comments_after_change
AFTER INSERT OR DELETE ON comments
FOR EACH ROW
EXECUTE FUNCTION update_comment_count();
```

---

### `public.likes`

```sql
CREATE TABLE public.likes (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  post_id BIGINT NOT NULL,
  user_id uuid NOT NULL,
  created_at timestamptz NOT NULL DEFAULT now(),
  CONSTRAINT likes_post_id_user_id_key UNIQUE (post_id, user_id),
  CONSTRAINT likes_post_id_fkey FOREIGN KEY (post_id) REFERENCES posts (id) ON DELETE CASCADE,
  CONSTRAINT likes_user_id_fkey FOREIGN KEY (user_id) REFERENCES profiles (id) ON DELETE CASCADE
);

CREATE TRIGGER likes_after_change
AFTER INSERT OR DELETE ON likes
FOR EACH ROW
EXECUTE FUNCTION update_like_count();
```

---

### `public.bookmarks`

```sql
CREATE TABLE public.bookmarks (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  post_id BIGINT NOT NULL,
  user_id uuid NOT NULL,
  created_at timestamptz NOT NULL DEFAULT now(),
  CONSTRAINT bookmarks_post_id_user_id_key UNIQUE (post_id, user_id),
  CONSTRAINT bookmarks_post_id_fkey FOREIGN KEY (post_id) REFERENCES posts (id) ON DELETE CASCADE,
  CONSTRAINT bookmarks_user_id_fkey FOREIGN KEY (user_id) REFERENCES profiles (id) ON DELETE CASCADE
);

CREATE TRIGGER bookmarks_after_change
AFTER INSERT OR DELETE ON bookmarks
FOR EACH ROW
EXECUTE FUNCTION update_save_count();
```

---

### `public.shares`

```sql
CREATE TABLE public.shares (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  post_id BIGINT NOT NULL,
  user_id uuid NOT NULL,
  created_at timestamptz NOT NULL DEFAULT now(),
  CONSTRAINT shares_post_id_fkey FOREIGN KEY (post_id) REFERENCES posts (id) ON DELETE CASCADE,
  CONSTRAINT shares_user_id_fkey FOREIGN KEY (user_id) REFERENCES profiles (id) ON DELETE CASCADE
);

CREATE TRIGGER shares_after_change
AFTER INSERT OR DELETE ON shares
FOR EACH ROW
EXECUTE FUNCTION update_share_count();
```

---

### `public.stories`

```sql
CREATE TABLE public.stories (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id uuid NOT NULL,
  media_url text NOT NULL,
  text text NULL,
  created_at timestamptz NOT NULL DEFAULT now(),
  expires_at timestamptz NOT NULL DEFAULT (now() + '24:00:00'::interval),
  CONSTRAINT stories_user_id_fkey FOREIGN KEY (user_id) REFERENCES profiles (id) ON DELETE CASCADE
);
```

---

### `public.story_reactions`

```sql
CREATE TABLE public.story_reactions (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  story_id BIGINT NOT NULL,
  user_id uuid NOT NULL,
  reaction_type public.reaction_type NOT NULL,
  created_at timestamptz NOT NULL DEFAULT now(),
  CONSTRAINT story_reactions_story_id_user_id_key UNIQUE (story_id, user_id),
  CONSTRAINT story_reactions_story_id_fkey FOREIGN KEY (story_id) REFERENCES stories (id) ON DELETE CASCADE,
  CONSTRAINT story_reactions_user_id_fkey FOREIGN KEY (user_id) REFERENCES profiles (id) ON DELETE CASCADE
);
```

---

## Functions

- `handle_new_user()`
- `handle_new_follower()`
- `handle_lost_follower()`
- `accept_follow_request()`
- `accept_all_follow_requests()`
- `update_comment_count()`
- `update_like_count()`
- `update_save_count()`
- `update_share_count()`


---

## Row Level Security Policies

###  `public.profiles`

```sql
CREATE POLICY "Allow authenticated users to read profiles"
ON public.profiles
FOR SELECT
USING (auth.role() = 'authenticated');

CREATE POLICY "Allow users to update their own profile"
ON public.profiles
FOR UPDATE
USING (auth.uid() = id);
```

###  `public.follow_requests`

```sql
CREATE POLICY "Allow read on requests"
ON public.follow_requests
FOR SELECT USING (auth.uid() = following_id OR auth.uid() = follower_id);

CREATE POLICY "Allow user to send a request"
ON public.follow_requests
FOR INSERT WITH CHECK (auth.uid() = follower_id);

CREATE POLICY "Allow user to delete a request"
ON public.follow_requests
FOR DELETE USING (auth.uid() = follower_id OR auth.uid() = following_id);
```

*(Similar policies exist for `followers`, `posts`, `stories`, `comments`, `likes`, `bookmarks`, `shares`, and `story_reactions`.)*


