# Database Schema

## Table: `public.bookmarks`
```sql
create table public.bookmarks (
  id bigint generated by default as identity not null,
  post_id bigint not null,
  user_id uuid not null,
  created_at timestamp with time zone not null default now(),
  constraint bookmarks_pkey primary key (id),
  constraint bookmarks_post_id_user_id_key unique (post_id, user_id),
  constraint bookmarks_post_id_fkey foreign key (post_id) references posts (id) on delete cascade,
  constraint bookmarks_user_id_fkey foreign key (user_id) references profiles (id) on delete cascade
) tablespace pg_default;

create trigger bookmarks_after_change
after insert or delete on bookmarks for each row
execute function update_save_count();
```

---

## Table: `public.follows`
```sql
create table public.follows (
  id bigint generated by default as identity not null,
  follower_id uuid not null,
  following_id uuid not null,
  created_at timestamp with time zone not null default now(),
  status public.request_status not null default 'accepted'::request_status,
  constraint follows_pkey primary key (id),
  constraint follows_follower_id_following_id_key unique (follower_id, following_id),
  constraint follows_follower_id_fkey foreign key (follower_id) references profiles (id) on delete cascade,
  constraint follows_following_id_fkey foreign key (following_id) references profiles (id) on delete cascade
) tablespace pg_default;
```

---

## Table: `public.likes`
```sql
create table public.likes (
  id bigint generated by default as identity not null,
  post_id bigint not null,
  user_id uuid not null,
  created_at timestamp with time zone not null default now(),
  constraint likes_pkey primary key (id),
  constraint likes_post_id_user_id_key unique (post_id, user_id),
  constraint likes_post_id_fkey foreign key (post_id) references posts (id) on delete cascade,
  constraint likes_user_id_fkey foreign key (user_id) references profiles (id) on delete cascade
) tablespace pg_default;

create trigger likes_after_change
after insert or delete on likes for each row
execute function update_like_count();
```

---

## Table: `public.posts`
```sql
create table public.posts (
  id bigint generated by default as identity not null,
  user_id uuid not null,
  text text null,
  media jsonb[] null,
  hashtags text[] null,
  location text null,
  visibility public.privacy_level not null default 'public'::privacy_level,
  is_private boolean not null default false,
  created_at timestamp with time zone not null default now(),
  updated_at timestamp with time zone null,
  like_count integer null default 0,
  share_count integer null default 0,
  save_count integer null default 0,
  comment_count integer null default 0,
  constraint posts_pkey primary key (id),
  constraint posts_user_id_fkey foreign key (user_id) references profiles (id) on delete cascade
) tablespace pg_default;
```

---

## Table: `public.privacy_settings`
```sql
create table public.privacy_settings (
  user_id uuid not null,
  profile_visibility public.privacy_level not null default 'public'::privacy_level,
  post_visibility public.privacy_level not null default 'public'::privacy_level,
  show_online_status boolean not null default true,
  allow_follow_requests boolean not null default true,
  allow_direct_messages public.privacy_level not null default 'public'::privacy_level,
  show_followers boolean not null default true,
  show_following boolean not null default true,
  allow_tagging boolean not null default true,
  allow_mentions public.privacy_level not null default 'public'::privacy_level,
  created_at timestamp with time zone not null default now(),
  updated_at timestamp with time zone null,
  constraint privacy_settings_pkey primary key (user_id),
  constraint privacy_settings_user_id_fkey foreign key (user_id) references profiles (id) on delete cascade
) tablespace pg_default;
```

---

## Table: `public.profiles`
```sql
create table public.profiles (
  id uuid not null,
  created_at timestamp with time zone not null default now(),
  updated_at timestamp with time zone null,
  display_name text null,
  username text null,
  bio text null,
  avatar_url text null,
  website text null,
  location text null,
  constraint profiles_pkey primary key (id),
  constraint profiles_username_key unique (username),
  constraint profiles_id_fkey foreign key (id) references auth.users (id) on delete cascade
) tablespace pg_default;
```

---

## Table: `public.shares`
```sql
create table public.shares (
  id bigint generated by default as identity not null,
  post_id bigint not null,
  user_id uuid not null,
  created_at timestamp with time zone not null default now(),
  constraint shares_pkey primary key (id),
  constraint shares_post_id_fkey foreign key (post_id) references posts (id) on delete cascade,
  constraint shares_user_id_fkey foreign key (user_id) references profiles (id) on delete cascade
) tablespace pg_default;

create trigger shares_after_change
after insert or delete on shares for each row
execute function update_share_count();
```

---

## Table: `public.stories`
```sql
create table public.stories (
  id bigint generated by default as identity not null,
  user_id uuid not null,
  media_url text not null,
  text text null,
  created_at timestamp with time zone not null default now(),
  expires_at timestamp with time zone not null default (now() + '24:00:00'::interval),
  constraint stories_pkey primary key (id),
  constraint stories_user_id_fkey foreign key (user_id) references profiles (id) on delete cascade
) tablespace pg_default;
```

---

## Table: `public.story_reactions`
```sql
create table public.story_reactions (
  id bigint generated by default as identity not null,
  story_id bigint not null,
  user_id uuid not null,
  reaction_type public.reaction_type not null,
  created_at timestamp with time zone not null default now(),
  constraint story_reactions_pkey primary key (id),
  constraint story_reactions_story_id_user_id_key unique (story_id, user_id),
  constraint story_reactions_story_id_fkey foreign key (story_id) references stories (id) on delete cascade,
  constraint story_reactions_user_id_fkey foreign key (user_id) references profiles (id) on delete cascade
) tablespace pg_default;
```



# PostgreSQL Functions

## Function: `create_profile_for_new_user`
**Schema:** `public`  
**Arguments:** None  
**Language:** `plpgsql`

```sql
CREATE OR REPLACE FUNCTION public.create_profile_for_new_user()
RETURNS trigger AS $$
BEGIN
  INSERT INTO public.profiles (id, display_name, username, avatar_url)
  VALUES (
    NEW.id,
    NEW.raw_user_meta_data->>'full_name',
    COALESCE(NEW.raw_user_meta_data->>'user_name', split_part(NEW.email, '@', 1)),
    NEW.raw_user_meta_data->>'avatar_url'
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

---

## Function: `handle_new_user`
**Schema:** `public`  
**Arguments:** None  
**Language:** `plpgsql`

```sql
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS trigger AS $$
BEGIN
  INSERT INTO public.profiles (id, username, display_name, avatar_url)
  VALUES (NEW.id, NEW.raw_user_meta_data->>'user_name', NEW.raw_user_meta_data->>'full_name', NEW.raw_user_meta_data->>'avatar_url');
  
  INSERT INTO public.privacy_settings (user_id)
  VALUES (NEW.id);
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

---

## Function: `update_comment_count`
**Schema:** `public`  
**Arguments:** None  
**Language:** `plpgsql`

```sql
CREATE OR REPLACE FUNCTION public.update_comment_count()
RETURNS trigger AS $$
DECLARE
  target_post INTEGER := COALESCE(NEW.post_id, OLD.post_id);
BEGIN
  UPDATE posts
  SET comment_count = (SELECT COUNT(*) FROM comments WHERE post_id = target_post)
  WHERE id = target_post;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

---

## Function: `update_like_count`
**Schema:** `public`  
**Arguments:** None  
**Language:** `plpgsql`

```sql
CREATE OR REPLACE FUNCTION public.update_like_count()
RETURNS trigger AS $$
BEGIN
  UPDATE posts
  SET like_count = (SELECT COUNT(*) FROM likes WHERE post_id = NEW.post_id)
  WHERE id = NEW.post_id;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

---

## Function: `update_save_count`
**Schema:** `public`  
**Arguments:** None  
**Language:** `plpgsql`

```sql
CREATE OR REPLACE FUNCTION public.update_save_count()
RETURNS trigger AS $$
BEGIN
  UPDATE posts
  SET save_count = (SELECT COUNT(*) FROM bookmarks WHERE post_id = NEW.post_id)
  WHERE id = NEW.post_id;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

---

## Function: `update_share_count`
**Schema:** `public`  
**Arguments:** None  
**Language:** `plpgsql`

```sql
CREATE OR REPLACE FUNCTION public.update_share_count()
RETURNS trigger AS $$
BEGIN
  UPDATE posts
  SET share_count = (SELECT COUNT(*) FROM shares WHERE post_id = NEW.post_id)
  WHERE id = NEW.post_id;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```
